<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Green View Index Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #000; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    .info-box {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(26, 26, 26, 0.85);
      color: white;
      padding: 20px;
      width: 300px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 10;
      user-select: none;
    }

    .info-box h2 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #3fb950;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .dot {
      height: 40px;
      width: 40px;
      border-radius: 50%;
      display: inline-block;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.6);
      opacity: 0.8;
    }

    #gvi-value {
      font-size: 28px;
      font-weight: bold;
    }

    #address {
      margin-top: 10px;
      color: #ccc;
      font-size: 13px;
    }

    .color-bar {
      height: 12px;
      margin-top: 15px;
      background: linear-gradient(to right, #3C2F2F, #FF9800, #D4A017, #4CAF50, #4CAF50);
      border-radius: 6px;
    }

    .color-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #ccc;
      margin-top: 4px;
    }

    canvas {
      margin-top: 10px;
      background: none;
    }

    #image-preview {
      margin-top: 10px;
      max-width: 100%;
      display: none;
      border-radius: 6px;
      box-shadow: 0 0 8px rgba(0,0,0,0.7);
    }

    #toggleDataBtn {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 20;
      padding: 4px 10px;
      border: none;
      border-radius: 4px;
      background-color: #3fb950;
      color: white;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      user-select: none;
      box-shadow: 0 0 6px #3fb950;
      transition: background-color 0.3s ease;
      letter-spacing: 0.02em;
    }
    #toggleDataBtn:hover {
      background-color: #36a840;
    }

    /* New toggle buttons for paired points */
    #pairToggleButtons {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
    }

    #pairToggleButtons button {
      background-color: #3fb950;
      border: none;
      padding: 4px 12px;
      color: white;
      font-weight: bold;
      font-size: 14px;
      border-radius: 5px;
      cursor: pointer;
      user-select: none;
      box-shadow: 0 0 6px #3fb950;
      transition: background-color 0.3s ease;
      width: 45%;
    }
    #pairToggleButtons button:disabled {
      background-color: #555;
      cursor: default;
      box-shadow: none;
    }
    #pairToggleButtons button:hover:enabled {
      background-color: #36a840;
    }
  </style>
</head>
<body>

<div id="map"></div>

<button id="toggleDataBtn">2009</button>

<div class="info-box">
  <h2>Green View Index</h2>
  <div class="legend">
    <span class="dot" id="gvi-dot" style="background-color:#3fb950;"></span>
    <span id="gvi-value">Hover or click a point</span>
  </div>
  <canvas id="histCanvas" width="280" height="60"></canvas>

  <div class="color-bar"></div>
  <div class="color-labels">
    <span>0%</span>
    <span>5%</span>
    <span>10%</span>
    <span>15%</span>
    <span>30%</span>
  </div>
  <div id="address">Hover or click a point</div>
  
  <div id="pairToggleButtons" style="display:none;">
    <button id="btnPrev" title="2009">&lt; 2009</button>
    <button id="btnNext" title="2019">2019 &gt;</button>
  </div>

  <img id="image-preview" alt="Street View Overlay">
</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1Ijoib3R0by15dSIsImEiOiJjbDVpMnpwenMwNDgyM2NvMngybGNiemh4In0.cnKIPTuXF8OWxFnZhb56mQ';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v10',
    center: [114.1779, 22.3235],
    zoom: 12.5
  });

  const canvas = document.getElementById('histCanvas');
  const ctx = canvas.getContext('2d');
  const bins = new Array(60).fill(0);
  let gviStats = [];

  const imagePreview = document.getElementById('image-preview');
  const toggleDataBtn = document.getElementById('toggleDataBtn');

  // Pair toggle buttons
  const pairToggleDiv = document.getElementById('pairToggleButtons');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');

  // URLs for datasets
  const dataUrls = {
    "2009": 'https://raw.githubusercontent.com/ottoykh/treepedia/refs/heads/main/geodata/2009GVI.geojson',
    "2019": 'https://raw.githubusercontent.com/ottoykh/treepedia/refs/heads/main/geodata/2019GVI.geojson'
  };

  // Data holders
  let data2009 = null;
  let data2019 = null;

  // Current main data shown on map (toggles 2009/2019 dataset)
  let currentYear = "2019";

  // Track selected paired points
  // Format: { "2009": feature, "2019": feature }
  let pairedPoints = null;
  // Which year currently displayed in paired view ("2009" or "2019")
  let pairedCurrentYear = null;

  function getColor(val) {
    if (val < 0.05) return '#3C2F2F'; // Dark brown (0-5%)
    if (val < 0.10) return '#FF9800'; // Orange (5-10%)
    if (val < 0.15) return '#D4A017'; // Yellow-green (10-15%)
    return '#4CAF50'; // Green (15-30% and above)
  }

  function drawHistogram(selected = null) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const max = Math.max(...bins) || 1;
    const barWidth = canvas.width / bins.length;

    if (gviStats.length === 0) return;

    const mean = gviStats.reduce((a, b) => a + b, 0) / gviStats.length;
    const std = Math.sqrt(gviStats.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / gviStats.length);

    ctx.fillStyle = 'rgba(255,255,255,0.1)';
    const stdStart = Math.max(0, mean - std);
    const stdEnd = Math.min(1, mean + std);
    ctx.fillRect(stdStart * canvas.width, 0, (stdEnd - stdStart) * canvas.width, canvas.height);

    ctx.beginPath();
    ctx.strokeStyle = '#3fb950';
    ctx.lineWidth = 2;
    for (let i = 0; i < bins.length; i++) {
      const x = i * barWidth + barWidth / 2;
      const y = canvas.height - (bins[i] / max) * 50;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();

    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(mean * canvas.width, 0);
    ctx.lineTo(mean * canvas.width, canvas.height);
    ctx.stroke();

    if (selected !== null) {
      ctx.strokeStyle = '#ff9933';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(selected * canvas.width, 0);
      ctx.lineTo(selected * canvas.width, canvas.height);
      ctx.stroke();
    }

    ctx.fillStyle = '#ccc';
    ctx.font = '10px Arial';
    ctx.fillText('GVI (%)', canvas.width / 2 - 15, canvas.height - 2);
    ctx.save();
    ctx.rotate(-Math.PI / 2);
    ctx.fillText('Count', -canvas.height / 2 - 10, 10);
    ctx.restore();

    ctx.font = '11px Arial';
    ctx.fillStyle = '#aaa';
    ctx.fillText('Histogram of Green View Index', 40, 10);
  }

  function loadImage(feature, year) {
    if (!feature) {
      imagePreview.style.display = 'none';
      return;
    }
    const filename = feature.properties.filename;
    const imageUrl = `https://raw.githubusercontent.com/ottoykh/treepedia/refs/heads/main/image/${year}/${filename}_overlay.jpg`;
    imagePreview.src = imageUrl;
    imagePreview.style.display = 'block';
    imagePreview.onerror = () => {
      imagePreview.style.display = 'none';
      console.error('Failed to load image:', imageUrl);
    };
  }

  // Haversine formula for distance between two lat/lng in meters
  function distanceMeters(lat1, lon1, lat2, lon2) {
    const R = 6371e3; // metres
    const phi1 = lat1 * Math.PI/180;
    const phi2 = lat2 * Math.PI/180;
    const dPhi = (lat2-lat1) * Math.PI/180;
    const dLambda = (lon2-lon1) * Math.PI/180;

    const a = Math.sin(dPhi/2) * Math.sin(dPhi/2) +
              Math.cos(phi1) * Math.cos(phi2) *
              Math.sin(dLambda/2) * Math.sin(dLambda/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));

    return R * c;
  }

  // Find nearest point in dataset (otherYearData) to selectedFeature within maxDistanceMeters
  function findNearestFeature(selectedFeature, otherYearData, maxDistanceMeters = 10) {
    const lat1 = selectedFeature.properties.lat;
    const lon1 = selectedFeature.properties.lng;
    let nearestFeature = null;
    let nearestDist = Infinity;
    for (const f of otherYearData.features) {
      const lat2 = f.properties.lat;
      const lon2 = f.properties.lng;
      const dist = distanceMeters(lat1, lon1, lat2, lon2);
      if (dist < nearestDist && dist <= maxDistanceMeters) {
        nearestDist = dist;
        nearestFeature = f;
      }
    }
    return nearestFeature;
  }

  // Show feature info in UI
  function showFeatureInfo(feature, year) {
    if (!feature) {
      document.getElementById('gvi-value').textContent = 'No Data';
      document.getElementById('gvi-dot').style.backgroundColor = '#555';
      document.getElementById('address').textContent = '';
      imagePreview.style.display = 'none';
      return;
    }
    const gvi = parseFloat(feature.properties.GVI);
    const gviPct = (gvi * 100).toFixed(1);
    const lat = feature.properties.lat.toFixed(5);
    const lng = feature.properties.lng.toFixed(5);
    const addr = `Lat: ${lat}, Lng: ${lng} (${year})`;

    document.getElementById('gvi-value').textContent = `${gviPct}%`;
    document.getElementById('gvi-dot').style.backgroundColor = getColor(gvi);
    document.getElementById('address').textContent = addr;
    loadImage(feature, year);
  }

  // Update toggle buttons inside info box based on pairedPoints state
  function updatePairToggleButtons() {
    if (!pairedPoints) {
      pairToggleDiv.style.display = 'none';
      return;
    }
    pairToggleDiv.style.display = 'flex';

    // Enable both buttons if both points exist
    btnPrev.disabled = !pairedPoints["2009"];
    btnNext.disabled = !pairedPoints["2019"];

    // Highlight the button of the current year displayed
    if (pairedCurrentYear === "2009") {
      btnPrev.style.backgroundColor = '#4caf50';
      btnNext.style.backgroundColor = '#3fb950';
    } else {
      btnNext.style.backgroundColor = '#4caf50';
      btnPrev.style.backgroundColor = '#3fb950';
    }
  }

  // Update map "click-dot" layer data to show current feature
  function updateClickDot(feature) {
    map.getSource('click-dot').setData({
      type: 'FeatureCollection',
      features: feature ? [{
        type: 'Feature',
        geometry: { type: 'Point', coordinates: feature.geometry.coordinates },
        properties: feature.properties
      }] : []
    });
  }

  // Load and show main data on map, draw histogram
  async function loadData(year) {
    currentYear = year;

    // Load both datasets if not loaded yet
    if (!data2009) {
      const resp2009 = await fetch(dataUrls["2009"]);
      data2009 = await resp2009.json();
    }
    if (!data2019) {
      const resp2019 = await fetch(dataUrls["2019"]);
      data2019 = await resp2019.json();
    }

    // Select which data to show on map
    const mainData = (year === "2019") ? data2019 : data2009;

    bins.fill(0);
    gviStats = mainData.features.map(f => parseFloat(f.properties.GVI));
    gviStats.forEach(val => {
      const bin = Math.min(Math.floor(val * 60), 59);
      bins[bin]++;
    });

    const meanGVI = gviStats.reduce((a, b) => a + b, 0) / gviStats.length;
    const meanGVIPct = (meanGVI * 100).toFixed(1);

    document.getElementById('gvi-value').textContent = `${meanGVIPct}%`;
    document.getElementById('gvi-dot').style.backgroundColor = getColor(meanGVI);
    document.getElementById('address').textContent = `Mean value (${year})`;
    imagePreview.style.display = 'none';
    drawHistogram();

    if (map.getSource('gvi-points')) {
      map.getSource('gvi-points').setData(mainData);
    } else {
      map.addSource('gvi-points', { type: 'geojson', data: mainData });
      map.addLayer({
        id: 'gvi-hitbox',
        type: 'circle',
        source: 'gvi-points',
        paint: {
          'circle-radius': 10,
          'circle-color': 'rgba(0, 0, 0, 0)',
          'circle-stroke-width': 0
        }
      });
      map.addLayer({
        id: 'gvi-layer',
        type: 'circle',
        source: 'gvi-points',
        paint: {
          'circle-radius': 4,
          'circle-color': [
            'interpolate',
            ['linear'],
            ['get', 'GVI'],
            0, '#3C2F2F',
            0.05, '#FF9800',
            0.10, '#D4A017',
            0.15, '#4CAF50',
            0.30, '#4CAF50'
          ],
          'circle-stroke-width': 0,
          'circle-opacity': 0.9
        }
      });

      map.addLayer({
        id: 'click-dot',
        type: 'circle',
        source: {
          type: 'geojson',
          data: { type: 'FeatureCollection', features: [] }
        },
        paint: {
          'circle-radius': 10,
          'circle-color': '#FF5722',
          'circle-opacity': 0.8,
          'circle-stroke-width': 1,
          'circle-stroke-color': '#FFFFFF'
        },
        filter: ['==', '$type', 'Point']
      });
    }
  }

  // Handle user clicking a point on the map
  function onFeatureClick(feature, year) {
    // Reset pairing
    pairedPoints = null;
    pairedCurrentYear = null;

    // Find paired feature from other year if any
    const otherYear = (year === "2019") ? "2009" : "2019";
    const otherData = (otherYear === "2019") ? data2019 : data2009;

    const pairedFeature = findNearestFeature(feature, otherData, 10);

    if (pairedFeature) {
      pairedPoints = {};
      pairedPoints[year] = feature;
      pairedPoints[otherYear] = pairedFeature;

      // Start by showing clicked year feature
      pairedCurrentYear = year;
      showFeatureInfo(pairedPoints[pairedCurrentYear], pairedCurrentYear);
      updatePairToggleButtons();
      updateClickDot(pairedPoints[pairedCurrentYear]);
    } else {
      // No pair found, just show clicked feature info
      showFeatureInfo(feature, year);
      pairToggleDiv.style.display = 'none';
      updateClickDot(feature);
    }
  }

  // Setup map interactions
  function setupMapInteractions() {
    map.on('mousemove', 'gvi-hitbox', (e) => {
      if (pairedPoints) return; // disable hover when paired view active

      const feature = e.features[0];
      map.getCanvas().style.cursor = 'pointer';

      const year = currentYear;

      showFeatureInfo(feature, year);
      updateClickDot(feature);
    });

    map.on('mouseleave', 'gvi-hitbox', () => {
      if (pairedPoints) return;

      map.getCanvas().style.cursor = '';
      const meanGVI = gviStats.reduce((a, b) => a + b, 0) / gviStats.length;
      const meanGVIPct = (meanGVI * 100).toFixed(1);
      document.getElementById('gvi-value').textContent = `${meanGVIPct}%`;
      document.getElementById('gvi-dot').style.backgroundColor = getColor(meanGVI);
      document.getElementById('address').textContent = `Mean value (${currentYear})`;
      imagePreview.style.display = 'none';
      drawHistogram();
      updateClickDot(null);
    });

    map.on('click', 'gvi-hitbox', (e) => {
      const feature = e.features[0];
      onFeatureClick(feature, currentYear);
    });
  }

  // Initialize app
  async function init() {
    await loadData(currentYear);
    setupMapInteractions();
  }

  // Handle toggle data button (2009/2019)
  toggleDataBtn.addEventListener('click', async () => {
    if (pairedPoints) {
      // If in paired view, clear pair and reload single year view
      pairedPoints = null;
      pairedCurrentYear = null;
      pairToggleDiv.style.display = 'none';
      updateClickDot(null);
    }
    currentYear = (currentYear === "2019") ? "2009" : "2019";
    toggleDataBtn.textContent = (currentYear === "2019") ? "2009" : "2019";
    await loadData(currentYear);
  });

  // Pair toggle buttons events
  btnPrev.addEventListener('click', () => {
    if (!pairedPoints) return;
    if (pairedCurrentYear === "2019" && pairedPoints["2009"]) {
      pairedCurrentYear = "2009";
      showFeatureInfo(pairedPoints["2009"], "2009");
      updatePairToggleButtons();
      updateClickDot(pairedPoints["2009"]);
    }
  });

  btnNext.addEventListener('click', () => {
    if (!pairedPoints) return;
    if (pairedCurrentYear === "2009" && pairedPoints["2019"]) {
      pairedCurrentYear = "2019";
      showFeatureInfo(pairedPoints["2019"], "2019");
      updatePairToggleButtons();
      updateClickDot(pairedPoints["2019"]);
    }
  });

  map.on('load', init);
</script>
</body>
</html>
