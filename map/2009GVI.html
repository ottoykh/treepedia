<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Green View Index Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; background: #000; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }

    .info-box {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(26, 26, 26, 0.85);
      color: white;
      padding: 20px;
      width: 260px;
      border-radius: 10px;
      font-size: 14px;
      z-index: 10;
    }

    .info-box h2 {
      margin: 0 0 10px;
      font-size: 16px;
      color: #3fb950;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }

    .dot {
      height: 40px;
      width: 40px;
      border-radius: 50%;
      display: inline-block;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.6);
      opacity: 0.8;
    }

    #gvi-value {
      font-size: 28px;
      font-weight: bold;
    }

    #address {
      margin-top: 10px;
      color: #ccc;
      font-size: 13px;
    }

    .color-bar {
      height: 12px;
      margin-top: 15px;
      background: linear-gradient(to right, #3C2F2F, #D4A017, #A9D62A, #4CAF50, #00BCD4);
      border-radius: 6px;
    }

    .color-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: #ccc;
      margin-top: 4px;
    }

    canvas {
      margin-top: 10px;
      background: none;
    }
  </style>
</head>
<body>

<div id="map"></div>

<div class="info-box">
  <h2>Green View Index</h2>
  <div class="legend">
    <span class="dot" id="gvi-dot" style="background-color:#3fb950;"></span>
    <span id="gvi-value">Hover or click a point</span>
  </div>
  <canvas id="histCanvas" width="240" height="60"></canvas>

  <div class="color-bar"></div>
  <div class="color-labels">
    <span>0%</span>
    <span>15%</span>
    <span>30%</span>
    <span>45%</span>
    <span>60%</span>
  </div>

  <strong>Address</strong>
  <div id="address">Hover or click a point</div>
</div>

<script>
  mapboxgl.accessToken = 'pk.eyJ1Ijoib3R0by15dSIsImEiOiJjbDVpMnpwenMwNDgyM2NvMngybGNiemh4In0.cnKIPTuXF8OWxFnZhb56mQ';

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/dark-v10',
    center: [114.1779, 22.3235],
    zoom: 12.5
  });

  const canvas = document.getElementById('histCanvas');
  const ctx = canvas.getContext('2d');
  const bins = new Array(60).fill(0);
  let gviStats = [];
  let clickFeature = null;
  let hoverFeature = null;

  function getColor(val) {
    if (val < 0.15) return '#3C2F2F';
    if (val < 0.30) return '#D4A017';
    if (val < 0.45) return '#A9D62A';
    if (val < 0.60) return '#4CAF50';
    return '#00BCD4';
  }
    
  function drawHistogram(selected = null) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const max = Math.max(...bins) || 1;
    const barWidth = canvas.width / bins.length;
  
    // Calculate mean and std
    const mean = gviStats.reduce((a, b) => a + b, 0) / gviStats.length;
    const std = Math.sqrt(gviStats.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / gviStats.length);
  
    // Draw standard deviation range lightly behind line
    ctx.fillStyle = 'rgba(255,255,255,0.1)';
    const stdStart = Math.max(0, mean - std);
    const stdEnd = Math.min(1, mean + std);
    ctx.fillRect(stdStart * canvas.width, 0, (stdEnd - stdStart) * canvas.width, canvas.height);
  
    // Draw line plot
    ctx.beginPath();
    ctx.strokeStyle = '#3fb950';
    ctx.lineWidth = 2;
    for (let i = 0; i < bins.length; i++) {
      const x = i * barWidth + barWidth / 2;
      const y = canvas.height - (bins[i] / max) * 50;
      if (i === 0) ctx.moveTo(x, y);
      else ctx.lineTo(x, y);
    }
    ctx.stroke();
  
    // Draw mean line (white)
    ctx.strokeStyle = '#ffffff';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(mean * canvas.width, 0);
    ctx.lineTo(mean * canvas.width, canvas.height);
    ctx.stroke();
  
    // Draw selected line if any (orange)
    if (selected !== null) {
      ctx.strokeStyle = '#ff9933';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(selected * canvas.width, 0);
      ctx.lineTo(selected * canvas.width, canvas.height);
      ctx.stroke();
    }
  }

  map.on('load', () => {
    fetch('https://raw.githubusercontent.com/ottoykh/treepedia/refs/heads/main/geodata/2009GVI.geojson')
      .then(res => res.json())
      .then(data => {
      gviStats = data.features.map(f => parseFloat(f.properties.GVI));
      gviStats.forEach(val => {
        const bin = Math.min(Math.floor(val * 60), 59);
        bins[bin]++;
      });
    
      // Calculate mean GVI for display
      const meanGVI = gviStats.reduce((a, b) => a + b, 0) / gviStats.length;
      const meanGVIPct = (meanGVI * 100).toFixed(1);
    
      // Update info box to show mean initially with color from legend
      document.getElementById('gvi-value').textContent = `${meanGVIPct}%`;
      document.getElementById('gvi-dot').style.backgroundColor = getColor(meanGVI);
      document.getElementById('address').textContent = 'Mean value';
    
      // Draw histogram with mean line only
      drawHistogram();

        map.addSource('gvi-points', {
          type: 'geojson',
          data
        });

        // Add invisible layer for larger clickable area
        map.addLayer({
          id: 'gvi-hitbox',
          type: 'circle',
          source: 'gvi-points',
          paint: {
            'circle-radius': 10, // Larger hitbox
            'circle-color': 'rgba(0, 0, 0, 0)', // Invisible
            'circle-stroke-width': 0
          }
        });

        // Add visible layer for original points
        map.addLayer({
          id: 'gvi-layer',
          type: 'circle',
          source: 'gvi-points',
          paint: {
            'circle-radius': 4,
            'circle-color': [
              'interpolate',
              ['linear'],
              ['get', 'GVI'],
              0, '#3C2F2F',
              0.15, '#D4A017',
              0.30, '#A9D62A',
              0.45, '#4CAF50',
              0.60, '#00BCD4'
            ],
            'circle-stroke-width': 0,
            'circle-opacity': 0.9
          }
        });

        // Add layer for the larger click dot
        map.addLayer({
          id: 'click-dot',
          type: 'circle',
          source: {
            type: 'geojson',
            data: {
              type: 'FeatureCollection',
              features: []
            }
          },
          paint: {
            'circle-radius': 10,
            'circle-color': '#FF5722',
            'circle-opacity': 0.8,
            'circle-stroke-width': 1,
            'circle-stroke-color': '#FFFFFF'
          },
          filter: ['==', '$type', 'Point']
        });

        // Add hover effect
        map.on('mousemove', 'gvi-hitbox', (e) => {
          const feature = e.features[0];
          hoverFeature = feature;
          map.getCanvas().style.cursor = 'pointer';

          const gvi = parseFloat(feature.properties.GVI);
          const gviPct = (gvi * 100).toFixed(1);
          const addr = `Lat: ${feature.properties.lat.toFixed(5)}, Lng: ${feature.properties.lng.toFixed(5)}`;

          document.getElementById('gvi-value').textContent = `${gviPct}%`;
          document.getElementById('gvi-dot').style.backgroundColor = getColor(gvi);
          document.getElementById('address').textContent = addr;

          // Update histogram on hover
          drawHistogram(gvi);

          // Preview larger dot on hover
          map.getSource('click-dot').setData({
            type: 'FeatureCollection',
            features: [{
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: feature.geometry.coordinates
              },
              properties: feature.properties
            }]
          });
        });

        map.on('mouseleave', 'gvi-hitbox', () => {
          map.getCanvas().style.cursor = '';
          hoverFeature = null;
          if (!clickFeature) {
            const meanGVI = gviStats.reduce((a, b) => a + b, 0) / gviStats.length;
            const meanGVIPct = (meanGVI * 100).toFixed(1);
            document.getElementById('gvi-value').textContent = `${meanGVIPct}%`;
            document.getElementById('gvi-dot').style.backgroundColor = getColor(meanGVI);
            document.getElementById('address').textContent = 'Mean value';
            drawHistogram();
            map.getSource('click-dot').setData({ type: 'FeatureCollection', features: [] });
          }
        });

        // Handle click to set persistent larger dot
        map.on('click', 'gvi-hitbox', (e) => {
          const feature = e.features[0];
          clickFeature = feature;

          const gvi = parseFloat(feature.properties.GVI);
          const gviPct = (gvi * 100).toFixed(1);
          const addr = `Lat: ${feature.properties.lat.toFixed(5)}, Lng: ${feature.properties.lng.toFixed(5)}`;

          document.getElementById('gvi-value').textContent = `${gviPct}%`;
          document.getElementById('gvi-dot').style.backgroundColor = getColor(gvi);
          document.getElementById('address').textContent = addr;

          drawHistogram(gvi);

          map.getSource('click-dot').setData({
            type: 'FeatureCollection',
            features: [{
              type: 'Feature',
              geometry: {
                type: 'Point',
                coordinates: feature.geometry.coordinates
              },
              properties: feature.properties
            }]
          });
        });
      });
  });
</script>

</body>
</html>